<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' http://localhost:* ws://localhost:* https://api.assemblyai.com wss://api.assemblyai.com wss://streaming.assemblyai.com https://api.anthropic.com data: blob:; font-src 'self' data:; worker-src 'self' blob: data:;">
    <title>ScribeCat</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Top Control Bar -->
        <header class="top-bar">
            <div class="app-title">
                <span class="cat-emoji">üê±</span>
                <h1>ScribeCat</h1>
            </div>
            
            <div class="header-actions">
                <button id="study-mode-btn" class="icon-btn" title="Study Mode">
                    <span class="study-icon">üìö</span>
                </button>
                
                <button id="settings-btn" class="icon-btn" title="Settings">
                    <span class="settings-icon">‚öôÔ∏è</span>
                </button>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Left Panel: Notes Editor -->
            <div class="left-panel">
                <div class="panel-header">
                    <h2>Notes</h2>
                    <select id="course-select" class="course-select-dropdown" title="Select Course (Optional)">
                        <option value="">No Course Selected</option>
                    </select>
                </div>
                
                <div class="formatting-toolbar">
                    <!-- Text Style Group -->
                    <div class="toolbar-group">
                        <button id="bold-btn" class="toolbar-btn" title="Bold ‚Ä¢ Ctrl+B">
                            <span class="btn-icon bold-icon">B</span>
                        </button>
                        <button id="italic-btn" class="toolbar-btn" title="Italic ‚Ä¢ Ctrl+I">
                            <span class="btn-icon italic-icon">I</span>
                        </button>
                        <button id="underline-btn" class="toolbar-btn" title="Underline ‚Ä¢ Ctrl+U">
                            <span class="btn-icon underline-icon">U</span>
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Headings Group -->
                    <div class="toolbar-group">
                        <button id="heading1-btn" class="toolbar-btn" title="Heading 1 ‚Ä¢ Ctrl+Shift+H">
                            <span class="btn-icon">H1</span>
                        </button>
                        <button id="heading2-btn" class="toolbar-btn" title="Heading 2 ‚Ä¢ Ctrl+Alt+H">
                            <span class="btn-icon">H2</span>
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- List Group -->
                    <div class="toolbar-group">
                        <button id="bullet-list-btn" class="toolbar-btn" title="Bullet List ‚Ä¢ Ctrl+Shift+8">
                            <span class="btn-icon list-icon">
                                <span class="list-bullet">‚Ä¢</span>
                                <span class="list-lines">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </span>
                            </span>
                        </button>
                        <button id="numbered-list-btn" class="toolbar-btn" title="Numbered List ‚Ä¢ Ctrl+Shift+7">
                            <span class="btn-icon list-icon">
                                <span class="list-number">1.</span>
                                <span class="list-lines">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </span>
                            </span>
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Link & Highlight Group -->
                    <div class="toolbar-group">
                        <button id="link-btn" class="toolbar-btn" title="Add Link ‚Ä¢ Ctrl+K">
                            <span class="btn-icon">üîó</span>
                        </button>
                        <button id="highlight-btn" class="toolbar-btn" title="Highlight ‚Ä¢ Ctrl+Shift+H">
                            <span class="btn-icon">‚ú®</span>
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- History Group -->
                    <div class="toolbar-group">
                        <button id="undo-btn" class="toolbar-btn" title="Undo ‚Ä¢ Ctrl+Z">
                            <span class="btn-icon">‚Ü∂</span>
                        </button>
                        <button id="redo-btn" class="toolbar-btn" title="Redo ‚Ä¢ Ctrl+Y">
                            <span class="btn-icon">‚Ü∑</span>
                        </button>
                    </div>
                    
                    <div class="toolbar-divider"></div>
                    
                    <!-- Clear Format -->
                    <button id="clear-format-btn" class="toolbar-btn" title="Clear Formatting">
                        <span class="btn-icon">‚úï</span>
                    </button>
                </div>
                
                <div id="tiptap-editor" class="tiptap-editor"></div>
                
                <div class="editor-footer">
                    <span id="char-count" class="count-display">0 characters</span>
                    <span class="count-separator">‚Ä¢</span>
                    <span id="word-count" class="count-display">0 words</span>
                </div>
            </div>
            
            <!-- Right Panel: Live Transcription -->
            <div class="right-panel">
                <div class="panel-header">
                    <h2>Live Transcription</h2>
                    <div class="panel-actions">
                        <button id="polish-btn" class="action-btn action-btn-icon" title="Polish transcription with AI" disabled>
                            ‚ú®
                        </button>
                        <button id="summarize-btn" class="action-btn action-btn-icon" title="Generate summary" disabled>
                            üìù
                        </button>
                        <button id="export-btn" class="action-btn action-btn-icon" title="Export transcription" disabled>
                            üì§
                        </button>
                    </div>
                </div>
                
                <div class="recording-controls-bar">
                    <button id="record-btn" class="record-btn" title="Start Recording">
                        <span class="record-icon"></span>
                    </button>
                    
                    <button id="pause-btn" class="pause-btn" title="Pause Recording" disabled>
                        <span class="pause-icon">‚è∏</span>
                    </button>
                    
                    <select id="microphone-select" class="device-select" title="Select Microphone">
                        <option value="">Loading devices...</option>
                    </select>
                    
                    <div class="vu-meter-container">
                        <div class="vu-meter-bg">
                            <div id="vu-meter" class="vu-meter"></div>
                        </div>
                    </div>
                </div>
                
                <div id="transcription-container" class="transcription-container">
                    <div class="transcription-placeholder">
                        Waiting for transcription...
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Study Mode View -->
        <div id="study-mode-view" class="study-mode-view hidden">
            <div class="study-mode-header">
                <h2>üìö Study Mode</h2>
                <button id="back-to-record-btn" class="secondary-btn">‚Üê Back to Recording</button>
            </div>
            
            <div class="study-mode-filters">
                <input 
                    type="text" 
                    id="study-search-input" 
                    class="filter-input" 
                    placeholder="üîç Search sessions..."
                    aria-label="Search sessions"
                >
                <select id="study-course-filter" class="filter-select" aria-label="Filter by course">
                    <option value="">All Courses</option>
                </select>
                <select id="study-sort-select" class="filter-select" aria-label="Sort sessions">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="longest">Longest First</option>
                    <option value="shortest">Shortest First</option>
                </select>
            </div>
            
            <div class="bulk-actions-bar hidden" id="bulk-actions-bar">
                <div class="bulk-actions-left">
                    <label class="checkbox-label">
                        <input type="checkbox" id="select-all-sessions">
                        <span id="selected-count">0 selected</span>
                    </label>
                </div>
                <div class="bulk-actions-right">
                    <button id="bulk-export-btn" class="action-btn" disabled>
                        üì§ Export Selected
                    </button>
                    <button id="bulk-delete-btn" class="action-btn delete-btn" disabled>
                        üóëÔ∏è Delete Selected
                    </button>
                </div>
            </div>
            
            <div id="session-list" class="session-list">
                <!-- Session cards will be populated by JavaScript -->
            </div>
            
            <div id="session-detail" class="session-detail hidden">
                <!-- Session detail view will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Bottom Status Bar -->
        <footer class="status-bar">
            <div class="status-left">
                <span class="status-label">Status:</span>
                <span id="recording-status" class="status-value">Idle</span>
                <span id="transcription-mode" class="mode-indicator"></span>
            </div>
            
            <div class="status-center">
                <span class="status-label">Time:</span>
                <span id="elapsed-time" class="status-value time-display">00:00</span>
            </div>
            
            <div class="status-right">
                <span id="session-info" class="status-value"></span>
            </div>
        </footer>
    </div>
    
    <!-- Floating AI Chat Button -->
    <button id="floating-chat-btn" class="floating-chat-btn" title="Open AI Chat" aria-label="Open AI Chat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="currentColor"/>
        </svg>
    </button>
    
    <!-- AI Chat Drawer -->
    <div id="ai-chat-drawer" class="ai-chat-drawer hidden">
        <div class="drawer-backdrop"></div>
        <div class="drawer-content">
            <div class="drawer-header">
                <h3>AI Assistant</h3>
                <button id="close-drawer-btn" class="close-drawer-btn" title="Close chat" aria-label="Close chat">√ó</button>
            </div>
            
            <div id="chat-messages" class="chat-messages">
                <div class="chat-welcome">
                    <p>üëã Hi! I'm your AI assistant. I can help you understand your transcription and notes better.</p>
                    <p>Ask me anything about the content!</p>
                </div>
            </div>
            
            <div class="chat-input-container">
                <input 
                    type="text" 
                    id="chat-input" 
                    class="chat-input" 
                    placeholder="Ask about your transcription or notes..."
                    disabled
                    aria-label="Chat message input"
                >
                <button id="send-chat-btn" class="send-chat-btn" title="Send message" aria-label="Send message" disabled>
                    ‚û§
                </button>
            </div>
            
            <div class="chat-options">
                <label class="chat-option-label">
                    <input type="checkbox" id="include-transcription" checked>
                    <span>Include transcription context</span>
                </label>
                <label class="chat-option-label">
                    <input type="checkbox" id="include-notes" checked>
                    <span>Include notes context</span>
                </label>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button id="close-settings-btn" class="close-btn" title="Close">√ó</button>
            </div>
            
            <div class="modal-body">
                <!-- Transcription Mode Section -->
                <section class="settings-section">
                    <h3>Transcription Mode</h3>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="transcription-mode" value="simulation" id="mode-simulation" checked>
                            <span class="radio-text">
                                <strong>Simulation Mode</strong>
                                <small>Testing mode with fake transcription</small>
                            </span>
                        </label>
                        
                        <label class="radio-label">
                            <input type="radio" name="transcription-mode" value="assemblyai" id="mode-assemblyai">
                            <span class="radio-text">
                                <strong>AssemblyAI</strong>
                                <small>Real-time streaming, word-by-word display</small>
                            </span>
                        </label>
                    </div>
                    <p class="help-text">
                        Simulation mode is for testing. AssemblyAI provides real-time streaming transcription with word-by-word display.
                    </p>
                </section>
                
                <!-- AssemblyAI Settings Section -->
                <section class="settings-section" id="assemblyai-settings">
                    <h3>AssemblyAI Configuration</h3>
                    <div class="form-group">
                        <label for="assemblyai-api-key">API Key:</label>
                        <input 
                            type="password" 
                            id="assemblyai-api-key" 
                            class="text-input" 
                            placeholder="Enter your AssemblyAI API key"
                        >
                        <small class="help-text">
                            Get your API key from <a href="https://www.assemblyai.com/dashboard/signup" target="_blank">AssemblyAI Dashboard</a>
                        </small>
                    </div>
                    <div class="status-row">
                        <label>Status:</label>
                        <span id="assemblyai-status" class="status-text">Not configured</span>
                    </div>
                </section>
                
                <!-- Claude AI Settings Section -->
                <section class="settings-section" id="claude-ai-settings">
                    <h3>Claude AI Configuration</h3>
                    <div class="form-group">
                        <label for="claude-api-key">API Key:</label>
                        <input 
                            type="password" 
                            id="claude-api-key" 
                            class="text-input" 
                            placeholder="Enter your Claude API key"
                        >
                        <small class="help-text">
                            Get your API key from <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a>
                        </small>
                    </div>
                    <div class="status-row">
                        <label>Status:</label>
                        <span id="claude-status-indicator" class="status-indicator">
                            <span class="status-icon">‚óè</span>
                            <span id="claude-status" class="status-text">Not configured</span>
                        </span>
                    </div>
                    <div class="button-row">
                        <button id="test-claude-connection" class="button button-secondary" type="button">
                            Test Connection
                        </button>
                    </div>
                    <p class="help-text">
                        Claude AI powers intelligent features: chat assistance, transcription polishing, 
                        smart summaries, and automatic title generation.
                    </p>
                </section>
                
                <!-- Auto-Polish Settings Section -->
                <section class="settings-section" id="auto-polish-settings">
                    <h3>Auto-Polish Transcription</h3>
                    <p class="help-text">
                        Automatically polish live transcription at regular intervals during recording. 
                        Requires Claude AI to be configured.
                    </p>
                    
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="auto-polish-enabled">
                            <span>Enable Auto-Polish</span>
                        </label>
                        <small class="help-text">
                            When enabled, transcription will be automatically polished during recording
                        </small>
                    </div>
                    
                    <div id="auto-polish-options" class="auto-polish-options" style="display: none;">
                        <div class="form-group">
                            <label for="auto-polish-interval">Polish Interval (seconds):</label>
                            <input 
                                type="number" 
                                id="auto-polish-interval" 
                                class="text-input" 
                                value="30"
                                min="15"
                                max="120"
                                step="5"
                            >
                            <small class="help-text">
                                How often to polish new transcription (default: 30 seconds)
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="auto-polish-jitter">Jitter Range (seconds):</label>
                            <input 
                                type="number" 
                                id="auto-polish-jitter" 
                                class="text-input" 
                                value="5"
                                min="0"
                                max="15"
                                step="1"
                            >
                            <small class="help-text">
                                Random variation in timing (¬±5 seconds prevents predictable patterns)
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="auto-polish-min-words">Minimum Words:</label>
                            <input 
                                type="number" 
                                id="auto-polish-min-words" 
                                class="text-input" 
                                value="50"
                                min="10"
                                max="200"
                                step="10"
                            >
                            <small class="help-text">
                                Minimum new words required before polishing (default: 50 words)
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="auto-polish-full-interval">Full Polish Interval (cycles):</label>
                            <input 
                                type="number" 
                                id="auto-polish-full-interval" 
                                class="text-input" 
                                value="5"
                                min="3"
                                max="10"
                                step="1"
                            >
                            <small class="help-text">
                                Re-polish entire transcription every N cycles for consistency (default: 5 cycles ‚âà 2.5 min)
                            </small>
                        </div>
                    </div>
                </section>
                
                <!-- Google Drive Settings Section -->
                <section class="settings-section" id="google-drive-settings">
                    <h3>Google Drive Integration</h3>
                    <div class="status-row">
                        <label>Status:</label>
                        <span id="drive-status" class="status-text">Not connected</span>
                    </div>
                    <div class="button-row">
                        <button id="connect-drive-btn" class="button button-primary" type="button">
                            Connect Google Drive
                        </button>
                        <button id="disconnect-drive-btn" class="button button-secondary" type="button" style="display: none;">
                            Disconnect
                        </button>
                    </div>
                    <p class="help-text">
                        Connect your Google Drive to automatically upload exported sessions. 
                        You'll be asked to sign in with your Google account.
                    </p>
                </section>
                
                <!-- Canvas LMS Settings Section -->
                <section class="settings-section" id="canvas-settings">
                    <h3>Canvas LMS Integration</h3>
                    
                    <!-- API Connection Method -->
                    <div class="canvas-method">
                        <h4>Method 1: Canvas API (Recommended)</h4>
                        <div class="form-group">
                            <label for="canvas-url">Canvas URL:</label>
                            <input 
                                type="text" 
                                id="canvas-url" 
                                class="text-input" 
                                placeholder="https://canvas.instructure.com"
                            >
                            <small class="help-text">
                                Enter your institution's Canvas URL (e.g., https://canvas.university.edu)
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="canvas-token">API Token:</label>
                            <input 
                                type="password" 
                                id="canvas-token" 
                                class="text-input" 
                                placeholder="Enter your Canvas API token"
                            >
                            <small class="help-text">
                                Get your API token from Canvas: Account ‚Üí Settings ‚Üí New Access Token
                            </small>
                        </div>
                        <div class="status-row">
                            <label>Status:</label>
                            <span id="canvas-status" class="status-text">Not configured</span>
                        </div>
                        <div class="button-row">
                            <button id="test-canvas-btn" class="button button-secondary" type="button">
                                Test Connection
                            </button>
                            <button id="disconnect-canvas-btn" class="button button-secondary" type="button" style="display: none;">
                                Disconnect
                            </button>
                        </div>
                    </div>
                    
                    <!-- Browser Extension Import Method -->
                    <div class="canvas-method" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #444;">
                        <h4>Method 2: Browser Extension Import</h4>
                        <p class="help-text">
                            If your university blocks Canvas API access, use our browser extension to import courses.
                            <a href="#" id="extension-help-link" style="color: #3498db;">Learn more</a>
                        </p>
                        <div class="form-group">
                            <label for="canvas-import-json">Paste JSON from Extension:</label>
                            <textarea 
                                id="canvas-import-json" 
                                class="text-input" 
                                rows="4"
                                placeholder='{"source": "ScribeCat Canvas Browser Extension", "format": "scribecat_course_import_v1", "courses": [...]}'
                            ></textarea>
                            <small class="help-text">
                                Install the extension, visit your Canvas dashboard, export courses, then paste the JSON here.
                            </small>
                        </div>
                        <div class="button-row">
                            <button id="import-canvas-courses-btn" class="button button-primary" type="button">
                                Import Courses
                            </button>
                        </div>
                        
                        <!-- Imported Courses List -->
                        <div id="imported-courses-container" style="margin-top: 20px; display: none;">
                            <h5>Imported Courses (<span id="imported-courses-count">0</span>)</h5>
                            <div id="imported-courses-list" class="courses-list"></div>
                        </div>
                    </div>
                </section>
                
                <!-- Theme Settings Section -->
                <section class="settings-section">
                    <h3>Theme</h3>
                    <p class="help-text">
                        Choose a theme that matches your mood and enhances your focus. 
                        Each theme is designed using color theory to evoke specific emotions.
                    </p>
                    
                    <div class="form-group">
                        <label for="theme-category-filter">Filter by Category:</label>
                        <select id="theme-category-filter" class="text-input">
                            <option value="all">All Themes</option>
                            <option value="calm">Calm & Peaceful</option>
                            <option value="energetic">Energetic & Motivated</option>
                            <option value="focus">Focus & Productivity</option>
                            <option value="creative">Creative & Inspired</option>
                            <option value="balanced">Balanced & Harmonious</option>
                        </select>
                    </div>
                    
                    <div id="theme-grid" class="theme-grid">
                        <!-- Themes will be populated by JavaScript -->
                    </div>
                </section>
                
                <!-- Audio Settings Section -->
                <section class="settings-section">
                    <h3>Audio Configuration</h3>
                    
                    <div class="info-row">
                        <span class="info-label">Sample Rate:</span>
                        <span class="info-value" id="sample-rate-display">16000 Hz</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Audio Format:</span>
                        <span class="info-value">PCM 16-bit Mono</span>
                    </div>
                </section>
            </div>
            
            <div class="modal-footer">
                <button id="cancel-settings-btn" class="secondary-btn">Cancel</button>
                <button id="save-settings-btn" class="primary-btn">Save Settings</button>
            </div>
        </div>
    </div>
    
    <script type="module" src="app.js"></script>
</body>
</html>
